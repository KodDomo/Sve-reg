<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sveriges Regenter</title>
    <style>
        :root{
            --bg:#f0f4f8;
            --card:#fff;
            --muted:#6b7280;
            --accent:#1a4b7c;
            --accent-strong:#007bff;
            --danger:#d93025;
            --panel-border:#cdd5de;
            --radius:12px;
            --max-width:680px;
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        html,body{height:100%}
        body{
            font-family:var(--ui-font);
            background:var(--bg);
            color:#222;
            margin:0;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
            box-sizing:border-box;
        }
        .container{
            width:100%;
            max-width:var(--max-width);
            background:var(--card);
            border-radius:var(--radius);
            box-shadow:0 8px 24px rgba(0,0,0,0.08);
            padding:24px;
            box-sizing:border-box;
        }
        header h1{ margin:0 0 12px 0; color:var(--accent); font-size:1.6rem; text-align:center; }
        .controls-grid{ display:grid; grid-template-columns:1fr 220px; gap:16px; align-items:flex-start; } /* Ändrad till flex-start */
        @media (max-width:720px){ .controls-grid{grid-template-columns:1fr;} }
        #regent-search{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--panel-border); font-size:1rem; box-sizing:border-box; }
        #regent-list{ margin-top:10px; max-height:220px; overflow:auto; border:1px solid var(--panel-border); border-radius:8px; background:#fff; }
        ul.regent-list{list-style:none; margin:0; padding:0;}
        li.regent-item{ padding:10px 12px; border-bottom:1px solid #f0f0f0; cursor:pointer; font-size:0.95rem; }
        li.regent-item:last-child{border-bottom:none}
        li.regent-item:hover, li.regent-item:focus{ background:#f4f8fa; outline:none; }
        li.regent-item.selected{ background:var(--accent-strong); color:#fff; font-weight:700; }
        .year-controls{ display:flex; gap:8px; align-items:center; justify-content:center; }
        .year-button{ padding:10px 14px; border-radius:8px; border:1px solid var(--panel-border); background:#f8f9fa; cursor:pointer; font-size:1.25rem; }
        .year-button:active{transform:translateY(1px)} .year-button:disabled{opacity:.5; cursor:not-allowed}
        #year-input{ width:110px; padding:10px 12px; border-radius:8px; border:1px solid var(--panel-border); text-align:center; font-size:1rem; }
        #year-range{width:100%}
        #result{ text-align:center; margin-top:18px; }
        #monarch-name{font-size:1.5rem; margin:6px 0}
        .info-text{color:var(--muted); margin:6px 0}
        #monarch-search-link{ display:inline-block; margin:10px 0; padding:10px 14px; background:#4285F4; color:#fff; text-decoration:none; border-radius:8px; }
        #monarch-search-link:hover{background:#357ae8}
        #message{color:var(--danger); text-align:center; margin-top:14px}
        button:focus, a:focus, input:focus, .regent-item:focus{ outline:3px solid rgba(21,156,228,0.25); outline-offset:2px; }
        footer{ text-align:center; color:#888; font-size:0.9rem; margin-top:14px; }
        .no-results{padding:12px; color:var(--muted); text-align:center}
    </style>
</head>
<body>
    <main class="container" id="app" aria-labelledby="title">
        <header><h1 id="title">Vem regerade?</h1></header>

        <section class="controls-grid" aria-label="Sök och välj regent">
            <div>
                <label for="regent-search">Sök regent (matchar medan du skriver):</label>
                <input type="search" id="regent-search" placeholder="T.ex. Erik Segersäll" autocomplete="off" />
                <div id="regent-list" aria-live="polite" aria-atomic="false">
                    <ul class="regent-list" id="regent-list-ul" role="list"></ul>
                </div>
            </div>

            <div>
                <label for="year-input">År</label>
                <div class="year-controls" role="group" aria-label="Årskontroller">
                    <button id="btn-down" class="year-button" aria-label="Föregående år">◄</button>
                    <input type="number" id="year-input" min="970" step="1" aria-label="År" />
                    <button id="btn-up" class="year-button" aria-label="Nästa år">►</button>
                </div>

                <div style="margin-top:10px">
                    <label for="year-range">Snabbval (drag för att ändra år)</label>
                    <input type="range" id="year-range" />
                </div>
            </div>
        </section>

        <div id="result" hidden aria-live="polite">
            <div class="monarch-nav" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <button id="btn-prev-regent" class="year-button" aria-label="Föregående regent">«</button>
                <h2 id="monarch-name" aria-live="polite"></h2>
                <button id="btn-next-regent" class="year-button" aria-label="Nästa regent">»</button>
            </div>

            <a id="monarch-search-link" href="#" target="_blank" rel="noopener noreferrer"></a>
            <p id="monarch-reign" class="info-text"></p>
            <p id="monarch-life" class="info-text"></p>
        </div>

        <p id="message" hidden role="status"></p>

        <footer id="version-timestamp"></footer>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === FIX: Hela regentdatabasen ===
        const monarchData = [
            { name: "Erik Segersäll", reign_start: 970, reign_end: 995, birth: null, death: 995 },
            { name: "Olof Skötkonung", reign_start: 995, reign_end: 1022, birth: 980, death: 1022 },
            { name: "Anund Jakob", reign_start: 1022, reign_end: 1050, birth: 1008, death: 1050 },
            { name: "Emund den gamle", reign_start: 1050, reign_end: 1060, birth: null, death: 1060 },
            { name: "Stenkil", reign_start: 1060, reign_end: 1066, birth: 1030, death: 1066 },
            { name: "Erik och Erik", reign_start: 1066, reign_end: 1067, birth: null, death: 1067 },
            { name: "Halsten", reign_start: 1067, reign_end: 1070, birth: null, death: 1084 },
            { name: "Anund Gårdske", reign_start: 1070, reign_end: 1075, birth: null, death: null },
            { name: "Håkan Röde", reign_start: 1075, reign_end: 1079, birth: null, death: null },
            { name: "Inge den äldre", reign_start: 1079, reign_end: 1084, birth: null, death: 1105 },
            { name: "Blot-Sven", reign_start: 1084, reign_end: 1087, birth: null, death: 1087 },
            { name: "Inge den äldre", reign_start: 1087, reign_end: 1105, birth: null, death: 1105 },
            { name: "Filip", reign_start: 1105, reign_end: 1118, birth: null, death: 1118 },
            { name: "Inge den yngre", reign_start: 1118, reign_end: 1125, birth: null, death: 1125 },
            { name: "Ragnvald Knaphövde", reign_start: 1125, reign_end: 1126, birth: null, death: 1126 },
            { name: "Magnus den starke", reign_start: 1125, reign_end: 1132, birth: 1106, death: 1134 },
            { name: "Sverker den äldre", reign_start: 1132, reign_end: 1156, birth: null, death: 1156 },
            { name: "Erik den helige", reign_start: 1156, reign_end: 1160, birth: 1120, death: 1160 },
            { name: "Magnus Henriksson", reign_start: 1160, reign_end: 1161, birth: null, death: 1161 },
            { name: "Karl Sverkersson", reign_start: 1161, reign_end: 1167, birth: 1130, death: 1167 },
            { name: "Knut Eriksson", reign_start: 1167, reign_end: 1196, birth: 1148, death: 1196 },
            { name: "Sverker den yngre", reign_start: 1196, reign_end: 1208, birth: 1164, death: 1210 },
            { name: "Erik Knutsson", reign_start: 1208, reign_end: 1216, birth: 1180, death: 1216 },
            { name: "Johan Sverkersson", reign_start: 1216, reign_end: 1222, birth: 1201, death: 1222 },
            { name: "Erik Eriksson (läspe och halte)", reign_start: 1222, reign_end: 1229, birth: 1216, death: 1250 },
            { name: "Knut Långe", reign_start: 1229, reign_end: 1234, birth: null, death: 1234 },
            { name: "Erik Eriksson (läspe och halte)", reign_start: 1234, reign_end: 1250, birth: 1216, death: 1250 },
            { name: "Valdemar Birgersson", reign_start: 1250, reign_end: 1275, birth: 1239, death: 1302 },
            { name: "Magnus Ladulås", reign_start: 1275, reign_end: 1290, birth: 1240, death: 1290 },
            { name: "Birger Magnusson", reign_start: 1290, reign_end: 1318, birth: 1280, death: 1321 },
            { name: "Magnus Eriksson", reign_start: 1319, reign_end: 1364, birth: 1316, death: 1374 },
            { name: "Erik Magnusson", reign_start: 1357, reign_end: 1359, birth: 1339, death: 1359 },
            { name: "Håkan Magnusson", reign_start: 1362, reign_end: 1364, birth: 1340, death: 1380 },
            { name: "Albrekt av Mecklenburg", reign_start: 1364, reign_end: 1389, birth: 1338, death: 1412 },
            { name: "Margareta", reign_start: 1389, reign_end: 1412, birth: 1353, death: 1412 },
            { name: "Erik av Pommern", reign_start: 1396, reign_end: 1439, birth: 1382, death: 1459 },
            { name: "Kristofer av Bayern", reign_start: 1441, reign_end: 1448, birth: 1416, death: 1448 },
            { name: "Karl Knutsson (Bonde)", reign_start: 1448, reign_end: 1457, birth: 1409, death: 1470 },
            { name: "Kristian I", reign_start: 1457, reign_end: 1464, birth: 1426, death: 1481 },
            { name: "Karl Knutsson (Bonde)", reign_start: 1464, reign_end: 1465, birth: 1409, death: 1470 },
            { name: "Karl Knutsson (Bonde)", reign_start: 1467, reign_end: 1470, birth: 1409, death: 1470 },
            { name: "Sten Sture den äldre", reign_start: 1470, reign_end: 1497, birth: 1440, death: 1503 },
            { name: "Hans (Johan II)", reign_start: 1497, reign_end: 1501, birth: 1455, death: 1513 },
            { name: "Sten Sture den äldre", reign_start: 1501, reign_end: 1503, birth: 1440, death: 1503 },
            { name: "Svante Nilsson (Sture)", reign_start: 1504, reign_end: 1512, birth: 1460, death: 1512 },
            { name: "Sten Sture den yngre", reign_start: 1512, reign_end: 1520, birth: 1493, death: 1520 },
            { name: "Kristian II", reign_start: 1520, reign_end: 1521, birth: 1481, death: 1559 },
            { name: "Gustav Vasa", reign_start: 1523, reign_end: 1560, birth: 1496, death: 1560 },
            { name: "Erik XIV", reign_start: 1560, reign_end: 1568, birth: 1533, death: 1577 },
            { name: "Johan III", reign_start: 1568, reign_end: 1592, birth: 1537, death: 1592 },
            { name: "Sigismund", reign_start: 1592, reign_end: 1599, birth: 1566, death: 1632 },
            { name: "Karl IX", reign_start: 1599, reign_end: 1611, birth: 1550, death: 1611 },
            { name: "Gustav II Adolf", reign_start: 1611, reign_end: 1632, birth: 1594, death: 1632 },
            { name: "Kristina", reign_start: 1632, reign_end: 1654, birth: 1626, death: 1689 },
            { name: "Karl X Gustav", reign_start: 1654, reign_end: 1660, birth: 1622, death: 1660 },
            { name: "Karl XI", reign_start: 1660, reign_end: 1697, birth: 1655, death: 1697 },
            { name: "Karl XII", reign_start: 1697, reign_end: 1718, birth: 1682, death: 1718 },
            { name: "Ulrika Eleonora", reign_start: 1718, reign_end: 1720, birth: 1688, death: 1741 },
            { name: "Fredrik I", reign_start: 1720, reign_end: 1751, birth: 1676, death: 1751 },
            { name: "Adolf Fredrik", reign_start: 1751, reign_end: 1771, birth: 1710, death: 1771 },
            { name: "Gustav III", reign_start: 1771, reign_end: 1792, birth: 1746, death: 1792 },
            { name: "Gustav IV Adolf", reign_start: 1792, reign_end: 1809, birth: 1778, death: 1837 },
            { name: "Karl XIII", reign_start: 1809, reign_end: 1818, birth: 1748, death: 1818 },
            { name: "Karl XIV Johan", reign_start: 1818, reign_end: 1844, birth: 1763, death: 1844 },
            { name: "Oscar I", reign_start: 1844, reign_end: 1859, birth: 1799, death: 1859 },
            { name: "Karl XV", reign_start: 1859, reign_end: 1872, birth: 1826, death: 1872 },
            { name: "Oscar II", reign_start: 1872, reign_end: 1907, birth: 1829, death: 1907 },
            { name: "Gustaf V", reign_start: 1907, reign_end: 1950, birth: 1858, death: 1950 },
            { name: "Gustaf VI Adolf", reign_start: 1950, reign_end: 1973, birth: 1882, death: 1973 },
            { name: "Carl XVI Gustaf", reign_start: 1973, reign_end: "nuvarande", birth: 1946, death: null }
        ];

        // Elementreferenser
        const yearInput = document.getElementById('year-input');
        const yearRange = document.getElementById('year-range');
        const btnDown = document.getElementById('btn-down');
        const btnUp = document.getElementById('btn-up');
        const regentSearch = document.getElementById('regent-search');
        const regentListUL = document.getElementById('regent-list-ul');
        const result = document.getElementById('result');
        const monarchName = document.getElementById('monarch-name');
        const monarchSearchLink = document.getElementById('monarch-search-link');
        const monarchReign = document.getElementById('monarch-reign');
        const monarchLife = document.getElementById('monarch-life');
        const message = document.getElementById('message');
        const btnPrevRegent = document.getElementById('btn-prev-regent');
        const btnNextRegent = document.getElementById('btn-next-regent');

        const currentYear = new Date().getFullYear();
        const earliestYear = 970;
        let currentMonarch = null;
        let debounceTimer = null;
        const DEBOUNCE_MS = 180;

        // Sätt min/max för input och range
        yearInput.min = earliestYear;
        yearInput.max = currentYear;
        yearRange.min = earliestYear;
        yearRange.max = currentYear;

        function findMonarchByYear(year){
            let n = parseInt(year,10);
            if (isNaN(n)) n = currentYear;
            // Sök baklänges
            return [...monarchData].reverse().find(m=>{
                const reignEnd = (m.reign_end === 'nuvarande') ? currentYear : m.reign_end;
                return n >= m.reign_start && n <= reignEnd;
            }) || null;
        }

        function formatLifeText(m){
            const b = m.birth, d = m.death;
            if (b == null && d == null) return 'Levde: Okänt';
            if (b == null && d != null) return `Levde: Okänt–${d}`;
            if (b != null && d == null) return `Född: ${b}`;
            return `Levde: ${b}–${d}`;
        }

        // === FIX 1: Ta bort de buggiga raderna ===
        function displayMonarch(m, displayYear){
            currentMonarch = m;
            if (m){
                monarchName.textContent = m.name;
                monarchSearchLink.href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(m.name)}`;
                monarchSearchLink.textContent = `Sök bild på ${m.name}`;
                monarchReign.textContent = `Regent: ${m.reign_start}–${m.reign_end === 'nuvarande' ? 'nuvarande' : m.reign_end}`;
                monarchLife.textContent = formatLifeText(m);
                
                // === BUGGEN VAR HÄR ===
                // Raderna nedan är borttagna för att stoppa den oändliga loopen.
                // yearInput.value = m.reign_start;
                // yearRange.value = m.reign_start;
                // ======================

                result.hidden = false;
                message.hidden = true;
                
                // Synkronisera knapparna
                const idx = monarchData.findIndex(x=>x.name===m.name && x.reign_start===m.reign_start);
                btnPrevRegent.disabled = (idx === 0);
                btnNextRegent.disabled = (idx === monarchData.length - 1);
                
                // Synkronisera listan
                syncSelectedListItem(m.reign_start, m.name);
                
            } else {
                result.hidden = true;
                btnPrevRegent.disabled = true;
                btnNextRegent.disabled = true;

                // FIX: Använd 'displayYear' för felmeddelandet
                const numericYear = parseInt(displayYear, 10);
                if (isNaN(numericYear)) {
                    message.textContent = `Välj ett årtal mellan ${earliestYear} och ${currentYear}.`;
                } else if (numericYear < earliestYear) {
                    message.textContent = `Data saknas före ca ${earliestYear}.`;
                } else if (numericYear > currentYear) {
                    message.textContent = `Året ${numericYear} har ännu inte inträffat.`;
                } else {
                    message.textContent = `Data saknas för år ${numericYear}.`;
                }
                message.hidden = false;
            }
        }

        function populateList(filter = ''){
            const q = String(filter).toLowerCase();
            regentListUL.innerHTML = '';
            const frag = document.createDocumentFragment();
            let hasResults = false;
            
            for (const m of monarchData){
                if (m.name.toLowerCase().includes(q)){
                    hasResults = true;
                    const li = document.createElement('li');
                    li.tabIndex = 0;
                    li.className = 'regent-item';
                    li.dataset.year = m.reign_start;
                    li.dataset.name = m.name;
                    li.role = 'option'; // Bättre ARIA-roll
                    const reignEndText = (m.reign_end === 'nuvarande') ? 'nu' : m.reign_end;
                    li.textContent = `${m.name} (${m.reign_start}–${reignEndText})`;
                    li.addEventListener('click', ()=>selectFromList(m.reign_start, m.name));
                    li.addEventListener('keydown', (e)=>{
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectFromList(m.reign_start, m.name); }
                    });
                    frag.appendChild(li);
                }
            }
            
            if (!hasResults){
                const empty = document.createElement('div');
                empty.className = 'no-results';
                empty.textContent = 'Inga regenter matchar sökningen.';
                regentListUL.appendChild(empty); // Lägg till i ul
            }
            regentListUL.appendChild(frag);
        }

        function syncSelectedListItem(year, name){
            // Se till att regentListUL.children finns
            if (regentListUL && regentListUL.children) {
                for (const item of regentListUL.children){
                    // Se till att 'item' är ett element (hoppa över .no-results)
                    if (item.classList.contains('regent-item')) {
                        const isSelected = (String(item.dataset.year) === String(year) && item.dataset.name === name);
                        item.classList.toggle('selected', isSelected);
                        if (isSelected){
                            item.scrollIntoView({block:'nearest'});
                        }
                    }
                }
            }
        }

        function selectFromList(year, name){
            regentSearch.value = '';
            populateList('');
            const m = monarchData.find(x => x.reign_start == year && x.name == name);
            if (m) {
                // Sätt årtalet här istället
                yearInput.value = m.reign_start;
                yearRange.value = m.reign_start;
                displayMonarch(m);
            }
        }

        // Huvudfunktion för att hantera alla årtalsändringar
        function onYearChange(newYearStr){
            let newYear = parseInt(newYearStr, 10);

            // Hantera ogiltigt/tomt värde
            if (isNaN(newYear)) {
                if (newYearStr === "") { // Om rutan är tom
                    currentMonarch = null;
                    displayMonarch(null, null); // Dölj allt
                    return; // Avbryt
                }
                newYear = currentYear; // Återställ till nuvarande år
            }

            if (newYear > currentYear) newYear = currentYear;
            if (newYear < earliestYear) newYear = earliestYear;
            
            // Sätt värdena
            yearInput.value = newYear;
            yearRange.value = newYear;
            
            if (regentSearch.value !== '') { 
                regentSearch.value = ''; 
                populateList(''); 
            }
            
            const m = findMonarchByYear(newYear);
            displayMonarch(m, newYear); // Skicka med året
        }

        // helper för att stega år
        function stepYear(delta){
            const cur = parseInt(yearInput.value, 10);
            const base = isNaN(cur) ? currentYear : cur;
            onYearChange(base + delta);
        }

        btnUp.addEventListener('click', () => stepYear(1));
        btnDown.addEventListener('click', () => stepYear(-1));

        btnPrevRegent.addEventListener('click', ()=> {
            if (!currentMonarch) return;
            const idx = monarchData.findIndex(x=>x.name===currentMonarch.name && x.reign_start===currentMonarch.reign_start);
            if (idx > 0) {
                const prev = monarchData[idx-1];
                yearInput.value = prev.reign_start; // Sätt året
                yearRange.value = prev.reign_start;
                displayMonarch(prev); // Visa
            }
        });
        btnNextRegent.addEventListener('click', ()=> {
            if (!currentMonarch) return;
            const idx = monarchData.findIndex(x=>x.name===currentMonarch.name && x.reign_start===currentMonarch.reign_start);
            if (idx < monarchData.length-1) {
                const next = monarchData[idx+1];
                yearInput.value = next.reign_start; // Sätt året
                yearRange.value = next.reign_start;
                displayMonarch(next); // Visa
            }
        });

        yearInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp'){ e.preventDefault(); stepYear(1); }
            else if (e.key === 'ArrowDown'){ e.preventDefault(); stepYear(-1); }
            else if (e.key === 'PageUp'){ e.preventDefault(); stepYear(10); }
            else if (e.key === 'PageDown'){ e.preventDefault(); stepYear(-10); }
        });

        // Sätt en flagga för att undvika loopar
        let isUpdatingFromRange = false;
        
        yearInput.addEventListener('input', ()=> {
            if (isUpdatingFromRange) return; // Ignorera input om den kom från rangern
            onYearChange(yearInput.value);
        });

        yearRange.addEventListener('input', ()=> {
            const v = parseInt(yearRange.value,10);
            if (!isNaN(v)) {
                isUpdatingFromRange = true; // Sätt flaggan
                yearInput.value = v; // Uppdatera input-fältet
                onYearChange(v);
                isUpdatingFromRange = false; // Nollställ flaggan
            }
        });

        regentSearch.addEventListener('input', ()=>{
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(()=>{ populateList(regentSearch.value); }, DEBOUNCE_MS);
        });

        regentListUL.addEventListener('keydown', (e)=>{
            const focusable = Array.from(regentListUL.querySelectorAll('.regent-item'));
            if (!focusable.length) return;
            const idx = focusable.indexOf(document.activeElement);
            if (e.key === 'ArrowDown'){ e.preventDefault(); const next = focusable[idx+1] || focusable[0]; if (next) next.focus(); }
            else if (e.key === 'ArrowUp'){ e.preventDefault(); const prev = focusable[idx-1] || focusable[focusable.length-1]; if (prev) prev.focus(); }
        });

        // Init
        populateList();
        yearInput.value = currentYear;
        yearRange.value = currentYear;
        const initial = findMonarchByYear(currentYear);
        displayMonarch(initial, currentYear);

        // === FIX 2: Hårdkodad tidsstämpel ===
        const footer = document.getElementById('version-timestamp');
        if (footer) {
            // Sätt datum och tid till när jag genererade denna kod
            footer.textContent = "Senast ändrad: 2025-11-12 kl. 11:15";
        }
    });
    </script>
</body>
</html>